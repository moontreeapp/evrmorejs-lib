import {
  createUnsignedTx,
  networks,
  payments,
  selectUtxos,
  multisigRedeemScript,
  crypto,
  signPsbt,
  finalizePsbt,
} from 'evrmorejs-lib';
import ECPairFactory from 'ecpair';
import * as ecc from 'tiny-secp256k1';

const ECPair = ECPairFactory(ecc);
const keyPair_1 = ECPair.fromWIF(
  'KxcXS9BzcRsZbqXhCK3sCTmSPW8Txh77iBAvB4fVM9BLJ7hJzEuF',
  networks.evrmore,
);
const keyPair_2 = ECPair.fromWIF(
  'L5h5ULcJCniNMZSVF1EcftQXAoVqsZCB88KNGXhncmZ51LvodoGq',
  networks.evrmore,
);

const keyPair_3 = ECPair.fromWIF(
  'KyWWcQpcqZqXKEkT7peHaj2f4SXBgRH2wWzEHzU1Z8AZWFh4w69C',
  networks.evrmore,
);

const redeemScript = multisigRedeemScript(2, [
  keyPair_1.publicKey,
  keyPair_2.publicKey,
  keyPair_3.publicKey,
]);
console.log(redeemScript.toString('hex'));
const { address: p2shAddress } = payments.p2sh({
  hash: crypto.hash160(redeemScript),
  network: networks.evrmore,
});

console.log(p2shAddress, typeof p2shAddress);

const fetchedUtxos = [
  {
    tx_hash: '726f861739f6ff6316d88f325580f6f628bc8c9c86c2903c6a5ff94ba09c9bff',
    tx_pos: 0,
    height: 1157802,
    asset: 'SATORI',
    value: 1,
  },
  {
    tx_hash: 'fcee0b42727073a6e9e41e284641329143650b333fb379037a6b7d836905f019',
    tx_pos: 1,
    height: 1162535,
    asset: 'CHUPPA_CHUB',
    value: 100000000,
  },
  {
    tx_hash: '3ae925f6b01b5105cc6183e25a8f1d7e9c2f20167e886a6f30414a78bf420db6',
    tx_pos: 3,
    height: 1165317,
    asset: 'SATORI',
    value: 4000000,
  },
  {
    tx_hash: 'c32cb139c2122af0a46000fa2d46351e0801ecd82ebfaac0e9709b4de599e6e3',
    tx_pos: 3,
    height: 1165409,
    asset: 'SATORI',
    value: 1000000,
  },
  {
    tx_hash: 'c25b5c39e03b28bebe5e4c072597942e6d0a834be82c7fd36cd72a02b4607690',
    tx_pos: 2,
    height: 1165411,
    asset: 'None',
    value: 14734000,
  },
  {
    tx_hash: 'c25b5c39e03b28bebe5e4c072597942e6d0a834be82c7fd36cd72a02b4607690',
    tx_pos: 3,
    height: 1165411,
    asset: 'SATORI',
    value: 5000000,
  },
  {
    tx_hash: '5cf9fe1e97448d3adcbd6025de43d91279121b41d9c7e5f6f23280384f237f87',
    tx_pos: 1,
    height: 1207104,
    asset: 'None',
    value: 10000000,
  },
  {
    tx_hash: '8e83ecfa83a8fe172e9930631c7a75108cc287945af548cdf98d756c88c79e58',
    tx_pos: 1,
    height: 1207469,
    asset: 'None',
    value: 100000,
  },
  {
    tx_hash: 'd2cecaf1055cd7a798d780b99920de84007057ed06dccb944fa03ebbc5571605',
    tx_pos: 1,
    height: 1214215,
    asset: 'None',
    value: 100000,
  },
];

const recepients = [
  // {
  //   address: "EdjxxjUJMUN8PcbRh5pwkPjkV5k6pyDX3y",
  //   amount: 1000000,
  //   asset: 'SATORI',
  // },
  {
    address: 'EdjxxjUJMUN8PcbRh5pwkPjkV5k6pyDX3y',
    amount: 10000000,
    asset: 'EVR',
  },
];

const selectedUtxos = selectUtxos(fetchedUtxos, recepients);
console.log(selectedUtxos);

const utxos = [
  {
    txid: 'c25b5c39e03b28bebe5e4c072597942e6d0a834be82c7fd36cd72a02b4607690',
    vout: 2,
    value: 14734000,
    nonWitnessUtxo: Buffer.from(
      '0100000004e3e699e54d9b70e9c0aabf2ed8ec01081e35462dfa0060a4f02a12c239b12cc302000000fdfd0000473044022022db0975b40176a7dabe99f4c0970043f15cd01c6252ee467306b35face2c7b802202e1713995c6e7a0ab5f80e3d09a2d83d32a4694e33935e37efd35227216e5b4401483045022100b8570921ce662802e1f578885c6eba5f9d248267933c6e28a769b84a568eefec022038c976aa98d79b2b78467a374dd8e2743475652248f52941f106fce2c7979595014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff461bccd4a72afd3d04e49fb08be3cda60b8538ed6752d3a52d373b708284c75300000000fdfd00004730440220106959afd882e8431237b161cbe466e5a47b833fc11066d194946fcfbc9a82ef0220271b02fd0c9be5a865a4f01ace6acdf2274e1a6117b22d64ba4f2d621808727901483045022100d86bae17be332f08b6925ce511931607f1c2284c957c325f6dbf6dba4c6f6fec022071df966d38dc6f5a94880acb164e85172815ae0c5da3f0efa84926efb23b77c1014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffffd158de3af89c69784e72255972f68039b01f0411ececd5cb7da519a4a3e840fd00000000fdfd0000483045022100a79a880c8cdb48bcbb3116177c707a3ea21345a2f44873acc06bbdff131e303a02207b00623f095b8e1bd33cb96c9ab54b89dff2b9e388f1a688fd748c228100a91b01473044022062f1e82312dd165a3731d9f78fb28185de548137c78d597026235584353529f3022055f4bbb469b54bc743049589ab52071af13c64150a7a08bafade5aa878b21485014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff48b26d29534c0d6c080180654a92a70a709487b7e6dac5fb120c4370c0b2f6d601000000fdfe0000483045022100a9010700c6009d2da31742df238bf42d7349554456306da9d492b3f99263a4ff022054291e13bccb056562bb7e381f2d903980f5001ff9a8553a0bc6b0f7c076788301483045022100c35d25b74ee2a852e045d32dac051493d1450f25a676ea2f94eb4c3fd007f7aa02204c61069f873988cd717163932808208d294053c255fde37ce7b14a722de04409014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff0440420f00000000001976a91431b935055f9bcb2fd2192a932c449c5f0f5291e088ac00000000000000002f76a91431b935055f9bcb2fd2192a932c449c5f0f5291e088acc01365767274065341544f5249002d31010000000075b0d2e0000000000017a91488784d7ed1f337eb57d01162d0ab4014c6598c0a8700000000000000002da91488784d7ed1f337eb57d01162d0ab4014c6598c0a87c01365767274065341544f5249404b4c00000000007500000000',
      'hex',
    ),
    asset: 'EVR',
  },
  // {
  //   txid: 'c32cb139c2122af0a46000fa2d46351e0801ecd82ebfaac0e9709b4de599e6e3',
  //   vout: 3,
  //   value: 1000000,
  //   nonWitnessUtxo: Buffer.from(
  //     '0100000003b60d42bf784a41306f6a887e16202f9c7e1d8f5ae28361cc05511bb0f625e93a02000000fdfd0000483045022100bc6f12f80954af05bd0f66baa115fe2366070b7afe039e5b7826f79bcde2750d0220399b7cc4d38f7cd60132ae13b737d82a4a8f9b6479be876b449181c161c34cd30147304402207666d0fc792c458e28a4135cdf7dea53551c65369597c80a81cb35ffc6dcab5402206d82d58b6a76d27b3f6a530bd823057060dedd73512e1ff7ebbc8dc87c1bbd61014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff5508029261c0ea64e77f4b5105f3a3a0538a0d6414c80f71b1217621c51a3c1c00000000fc00463043021f2630e4daf764c221353557123c85b7d8822e0d0e22485c2e3ab49da179b18b022062374c744be844b8097eeda6a221e3571e9484b3a53f1fb2bd0f65897fad4f2301483045022100b3ec22d147d282738ac4e86d54621b02ab297a88af0c0d41554b88a50d90a5e102204c01d52fad4b24d370254ad1212618327ec70561cf1c290236b7ee913d50a3b8014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff3216fca03713aa044a216209434955edddb27564d445e3ddcec1ab233c6463e800000000fc0047304402200c27912f1272eb6622631f0de07c5fd4e9ab29f8910f895cd068e0929eb92f9b022074a1f0c3062a83c6b832d568a96ded66e0a2be91e225f27ebacc13ec352ba4910147304402204de554f2da22ed6f9fd2840adb6f0b37a0cbdd2b064a692f7f1242f4d793ecbe0220379e5bef906d860e64b62f09fddbe5414f914562385f5f82400b48c2113bb675014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff0440420f00000000001976a91431b935055f9bcb2fd2192a932c449c5f0f5291e088ac00000000000000002f76a91431b935055f9bcb2fd2192a932c449c5f0f5291e088acc01365767274065341544f5249808d5b000000000075705205010000000017a91488784d7ed1f337eb57d01162d0ab4014c6598c0a8700000000000000002da91488784d7ed1f337eb57d01162d0ab4014c6598c0a87c01365767274065341544f524940420f00000000007500000000',
  //     'hex',
  //   ),
  //   asset: 'SATORI',
  // },
  // {
  //   txid: '3ae925f6b01b5105cc6183e25a8f1d7e9c2f20167e886a6f30414a78bf420db6',
  //   vout: 3,
  //   value: 4000000,
  //   nonWitnessUtxo: Buffer.from(
  //     '010000000248b26d29534c0d6c080180654a92a70a709487b7e6dac5fb120c4370c0b2f6d602000000fdfe0000483045022100f182cc6d37edb4b304e402e9be477a7bf51706ccd933a59487662a47c01add3b0220595cbce3f55a8b2e9a48a6503f0ce02d8096aa99d1500321b13a3b71d2d9f2340148304502210092983d34d87ac599fdd2209f3d519e5d3f4a47e874eaf53ff43f608d3b78db8002205b11c8373287c2ffe6d799fe70422b13d999c5c3385f0fd4aaaf982385012e1f014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffffe4cbb843c5e5af33cc3df9873f6fae00a09842c57ae0e3641fcf715b2de8f57500000000fc00473044022030a23aad78ced6548e25d26b42d5d88b12add3eb504138e9d30bf5ba371b944502207588586230e5a05fff3063a886c5e22a64e1184008fcad491a61b1e5bb51c3100147304402207e8387dce1dbc378df8f84048864657ffe31c12e104a24e6c33432cc6aae292c0220540db44de3f7cfabc67333742d17277e08bc64c70bfa8824db423e57dfe732b1014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff0440420f00000000001976a91431b935055f9bcb2fd2192a932c449c5f0f5291e088ac00000000000000002f76a91431b935055f9bcb2fd2192a932c449c5f0f5291e088acc01365767274065341544f524940420f000000000075905d25010000000017a91488784d7ed1f337eb57d01162d0ab4014c6598c0a8700000000000000002da91488784d7ed1f337eb57d01162d0ab4014c6598c0a87c01365767274065341544f524900093d00000000007500000000',
  //     'hex',
  //   ),
  //   asset: 'SATORI',
  // },
  // {
  //   txid: 'c25b5c39e03b28bebe5e4c072597942e6d0a834be82c7fd36cd72a02b4607690',
  //   vout: 3,
  //   value: 5000000,
  //   nonWitnessUtxo: Buffer.from(
  //     '0100000004e3e699e54d9b70e9c0aabf2ed8ec01081e35462dfa0060a4f02a12c239b12cc302000000fdfd0000473044022022db0975b40176a7dabe99f4c0970043f15cd01c6252ee467306b35face2c7b802202e1713995c6e7a0ab5f80e3d09a2d83d32a4694e33935e37efd35227216e5b4401483045022100b8570921ce662802e1f578885c6eba5f9d248267933c6e28a769b84a568eefec022038c976aa98d79b2b78467a374dd8e2743475652248f52941f106fce2c7979595014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff461bccd4a72afd3d04e49fb08be3cda60b8538ed6752d3a52d373b708284c75300000000fdfd00004730440220106959afd882e8431237b161cbe466e5a47b833fc11066d194946fcfbc9a82ef0220271b02fd0c9be5a865a4f01ace6acdf2274e1a6117b22d64ba4f2d621808727901483045022100d86bae17be332f08b6925ce511931607f1c2284c957c325f6dbf6dba4c6f6fec022071df966d38dc6f5a94880acb164e85172815ae0c5da3f0efa84926efb23b77c1014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffffd158de3af89c69784e72255972f68039b01f0411ececd5cb7da519a4a3e840fd00000000fdfd0000483045022100a79a880c8cdb48bcbb3116177c707a3ea21345a2f44873acc06bbdff131e303a02207b00623f095b8e1bd33cb96c9ab54b89dff2b9e388f1a688fd748c228100a91b01473044022062f1e82312dd165a3731d9f78fb28185de548137c78d597026235584353529f3022055f4bbb469b54bc743049589ab52071af13c64150a7a08bafade5aa878b21485014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff48b26d29534c0d6c080180654a92a70a709487b7e6dac5fb120c4370c0b2f6d601000000fdfe0000483045022100a9010700c6009d2da31742df238bf42d7349554456306da9d492b3f99263a4ff022054291e13bccb056562bb7e381f2d903980f5001ff9a8553a0bc6b0f7c076788301483045022100c35d25b74ee2a852e045d32dac051493d1450f25a676ea2f94eb4c3fd007f7aa02204c61069f873988cd717163932808208d294053c255fde37ce7b14a722de04409014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff0440420f00000000001976a91431b935055f9bcb2fd2192a932c449c5f0f5291e088ac00000000000000002f76a91431b935055f9bcb2fd2192a932c449c5f0f5291e088acc01365767274065341544f5249002d31010000000075b0d2e0000000000017a91488784d7ed1f337eb57d01162d0ab4014c6598c0a8700000000000000002da91488784d7ed1f337eb57d01162d0ab4014c6598c0a87c01365767274065341544f5249404b4c00000000007500000000',
  //     'hex',
  //   ),
  //   asset: 'SATORI',
  // },
];
if (!p2shAddress) {
  throw new Error('p2shAddress is undefined');
}
const unsignedTx = createUnsignedTx(utxos, recepients, p2shAddress, 2000);
console.log('unsignedTx', unsignedTx);
const psbt1 = signPsbt(unsignedTx, keyPair_1, redeemScript);
const psbt2 = signPsbt(unsignedTx, keyPair_2, redeemScript);
const finalizedTx = finalizePsbt([psbt1, psbt2]);
console.log('finalizedTx', finalizedTx);
